<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LingoSpark - OAuth èªè­‰å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        .status {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        .status.info {
            background: #e3f2fd;
            color: #1976d2;
            border: 1px solid #90caf9;
        }
        .status.success {
            background: #e8f5e9;
            color: #388e3c;
            border: 1px solid #81c784;
        }
        .status.error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ef5350;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-bottom: 20px;
            transition: all 0.3s;
        }
        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        .token-display {
            background: #f5f5f5;
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            word-break: break-all;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .token-display.hidden {
            display: none;
        }
        .copy-btn {
            background: #4caf50;
            margin-top: 10px;
        }
        .copy-btn:hover {
            background: #45a049;
        }
        .divider {
            margin: 30px 0;
            text-align: center;
            position: relative;
        }
        .divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #ddd;
        }
        .divider span {
            background: white;
            padding: 0 15px;
            position: relative;
            color: #999;
            font-size: 12px;
        }
        .token-input-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #f0f0f0;
        }
        textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            resize: vertical;
            margin-bottom: 10px;
        }
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        .set-token-btn {
            background: #ff9800;
        }
        .set-token-btn:hover {
            background: #f57c00;
        }
        .instructions {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            font-size: 13px;
            color: #856404;
        }
        .instructions ol {
            margin-left: 20px;
            margin-top: 10px;
        }
        .instructions li {
            margin-bottom: 8px;
        }
        code {
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
    </style>
    <!-- Google Identity Services for Drive API -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
</head>
<body>
    <div class="container">
        <h1>ğŸ” OAuth èªè­‰å·¥å…·</h1>
        <p class="subtitle">ç”¨æ–¼åœ¨çœŸå¯¦ç€è¦½å™¨ä¸­å®Œæˆèªè­‰ä¸¦å–å¾— Token</p>
        
        <div id="status" class="status info">
            â³ æ­£åœ¨åˆå§‹åŒ– Google API...
        </div>
        
        <button id="authBtn" onclick="startAuth()" disabled>é–‹å§‹èªè­‰</button>
        
        <div id="tokenDisplay" class="token-display hidden">
            <strong>Token è³‡è¨Šï¼š</strong><br><br>
            <div id="tokenContent"></div>
            <button class="copy-btn" onclick="copyToken()">ğŸ“‹ è¤‡è£½ Token JSON</button>
        </div>
        
        <div class="divider">
            <span>æˆ–</span>
        </div>
        
        <div class="token-input-section">
            <h2 style="font-size: 18px; margin-bottom: 15px; color: #333;">ğŸ”‘ æ‰‹å‹•è¼¸å…¥ Tokenï¼ˆç”¨æ–¼è‡ªå‹•åŒ–æ¸¬è©¦ï¼‰</h2>
            <p style="font-size: 13px; color: #666; margin-bottom: 10px;">
                å¦‚æœä½ å·²ç¶“å¾å…¶ä»–åœ°æ–¹å–å¾— Token JSONï¼Œå¯ä»¥åœ¨æ­¤è²¼ä¸Šä¸¦è¨­ç½®ï¼š
            </p>
            <textarea id="tokenInput" placeholder='è²¼ä¸Š Token JSONï¼Œä¾‹å¦‚ï¼š&#10;{&#10;  "access_token": "ya29.a0AfH6...",&#10;  "expires_in": 3600,&#10;  "scope": "https://www.googleapis.com/auth/drive.appdata",&#10;  "token_type": "Bearer"&#10;}'></textarea>
            <button class="set-token-btn" onclick="setTokenFromInput()">âœ… è¨­ç½® Token</button>
            <div id="setTokenStatus" style="margin-top: 10px; display: none;"></div>
        </div>
        
        <div class="instructions">
            <strong>ğŸ“‹ ä½¿ç”¨èªªæ˜ï¼š</strong>
            <p style="margin-bottom: 10px; font-weight: bold;">æ–¹å¼ä¸€ï¼šåœ¨æ­¤é é¢å®Œæˆèªè­‰</p>
            <ol>
                <li>é»æ“Šã€Œé–‹å§‹èªè­‰ã€æŒ‰éˆ•</li>
                <li>åœ¨å½ˆå‡ºè¦–çª—ä¸­å®Œæˆ Google å¸³è™Ÿç™»å…¥</li>
                <li>æˆæ¬Šæ‡‰ç”¨ç¨‹å¼å­˜å– Google Drive</li>
                <li>èªè­‰æˆåŠŸå¾Œï¼ŒToken æœƒé¡¯ç¤ºåœ¨ä¸Šæ–¹</li>
                <li>é»æ“Šã€Œè¤‡è£½ Token JSONã€æŒ‰éˆ•è¤‡è£½å®Œæ•´ Token</li>
            </ol>
            <p style="margin: 15px 0 10px 0; font-weight: bold;">æ–¹å¼äºŒï¼šæ‰‹å‹•è¼¸å…¥ Tokenï¼ˆç”¨æ–¼è‡ªå‹•åŒ–æ¸¬è©¦ï¼‰</p>
            <ol>
                <li>å¦‚æœä½ å·²ç¶“å¾å…¶ä»–åœ°æ–¹å–å¾— Token JSON</li>
                <li>åœ¨ã€Œæ‰‹å‹•è¼¸å…¥ Tokenã€å€åŸŸè²¼ä¸Š Token JSON</li>
                <li>é»æ“Šã€Œè¨­ç½® Tokenã€æŒ‰éˆ•</li>
                <li>è¨­ç½®æˆåŠŸå¾Œï¼Œå³å¯åœ¨æ­¤é é¢æˆ–ä¸»æ‡‰ç”¨ä¸­ä½¿ç”¨é›²ç«¯å‚™ä»½åŠŸèƒ½</li>
            </ol>
            <p style="margin-top: 10px; font-weight: bold; color: #d32f2f;">
                âš ï¸ æ³¨æ„ï¼šToken æœ‰æ™‚æ•ˆæ€§ï¼ˆé€šå¸¸ 1 å°æ™‚ï¼‰ï¼ŒéæœŸå¾Œéœ€è¦é‡æ–°èªè­‰
            </p>
            <p style="margin-top: 10px; font-size: 12px; color: #666;">
                ğŸ’¡ æç¤ºï¼šè¨­ç½® Token å¾Œï¼Œå¯ä»¥åœ¨ä¸»æ‡‰ç”¨ï¼ˆhttp://localhost:3000ï¼‰ä¸­ä½¿ç”¨é›²ç«¯å‚™ä»½åŠŸèƒ½ï¼Œæˆ–åœ¨æ­¤é é¢æ¸¬è©¦ API èª¿ç”¨ã€‚
            </p>
        </div>
    </div>

    <script>
        const CLIENT_ID = "885392911088-ibmq2i05lfk0ih49nv4p8lgc4g36kvlt.apps.googleusercontent.com";
        const SCOPES = "https://www.googleapis.com/auth/drive.appdata";
        
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        
        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }
        
        function checkInit() {
            if (window.gapi && window.google) {
                initGapi();
            } else {
                setTimeout(checkInit, 500);
            }
        }
        
        async function initGapi() {
            try {
                await window.gapi.load('client', async () => {
                    await window.gapi.client.init({
                        discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
                    });
                    gapiInited = true;
                    maybeEnableAuth();
                });
                
                tokenClient = window.google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: handleAuthResponse,
                });
                gisInited = true;
                maybeEnableAuth();
            } catch (error) {
                updateStatus('âŒ åˆå§‹åŒ–å¤±æ•—: ' + error.message, 'error');
            }
        }
        
        function maybeEnableAuth() {
            if (gapiInited && gisInited) {
                updateStatus('âœ… åˆå§‹åŒ–å®Œæˆï¼Œå¯ä»¥é–‹å§‹èªè­‰', 'success');
                document.getElementById('authBtn').disabled = false;
            }
        }
        
        function startAuth() {
            updateStatus('â³ æ­£åœ¨é–‹å•Ÿèªè­‰è¦–çª—...', 'info');
            document.getElementById('authBtn').disabled = true;
            
            // Check if we already have a token
            const token = window.gapi.client.getToken();
            if (token === null) {
                tokenClient.requestAccessToken({ prompt: 'consent' });
            } else {
                handleAuthResponse({});
            }
        }
        
        function handleAuthResponse(response) {
            if (response.error) {
                updateStatus('âŒ èªè­‰å¤±æ•—: ' + (response.error_description || response.error), 'error');
                document.getElementById('authBtn').disabled = false;
                return;
            }
            
            const token = window.gapi.client.getToken();
            if (token && token.access_token) {
                const tokenData = {
                    access_token: token.access_token,
                    expires_in: token.expires_in,
                    scope: token.scope,
                    token_type: token.token_type,
                    // Note: refresh_token might not be available in this flow
                };
                
                displayToken(tokenData);
                updateStatus('âœ… èªè­‰æˆåŠŸï¼Token å·²é¡¯ç¤º', 'success');
            } else {
                updateStatus('âŒ ç„¡æ³•å–å¾— Token', 'error');
                document.getElementById('authBtn').disabled = false;
            }
        }
        
        function displayToken(tokenData) {
            const tokenDisplay = document.getElementById('tokenDisplay');
            const tokenContent = document.getElementById('tokenContent');
            
            tokenContent.innerHTML = `
                <strong>Access Token:</strong><br>
                <code style="font-size: 10px;">${tokenData.access_token.substring(0, 50)}...</code><br><br>
                <strong>å®Œæ•´ Token JSON:</strong><br>
                <pre style="background: white; padding: 10px; border-radius: 5px; margin-top: 10px;">${JSON.stringify(tokenData, null, 2)}</pre>
            `;
            
            tokenDisplay.classList.remove('hidden');
            window.tokenData = tokenData; // Store globally for copy function
        }
        
        function copyToken() {
            if (!window.tokenData) {
                alert('æ²’æœ‰å¯è¤‡è£½çš„ Token');
                return;
            }
            
            const tokenJson = JSON.stringify(window.tokenData, null, 2);
            navigator.clipboard.writeText(tokenJson).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'âœ… å·²è¤‡è£½ï¼';
                btn.style.background = '#4caf50';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '#4caf50';
                }, 2000);
            }).catch(err => {
                alert('è¤‡è£½å¤±æ•—: ' + err.message);
            });
        }
        
        async function setTokenFromInput() {
            const tokenInput = document.getElementById('tokenInput');
            const statusEl = document.getElementById('setTokenStatus');
            const tokenText = tokenInput.value.trim();
            
            if (!tokenText) {
                statusEl.className = 'status error';
                statusEl.textContent = 'âŒ è«‹è¼¸å…¥ Token JSON';
                statusEl.style.display = 'block';
                return;
            }
            
            let tokenData;
            try {
                tokenData = JSON.parse(tokenText);
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = 'âŒ Token JSON æ ¼å¼éŒ¯èª¤: ' + error.message;
                statusEl.style.display = 'block';
                return;
            }
            
            if (!tokenData.access_token) {
                statusEl.className = 'status error';
                statusEl.textContent = 'âŒ Token JSON ç¼ºå°‘ access_token æ¬„ä½';
                statusEl.style.display = 'block';
                return;
            }
            
            statusEl.className = 'status info';
            statusEl.textContent = 'â³ æ­£åœ¨è¨­ç½® Token...';
            statusEl.style.display = 'block';
            
            try {
                // Wait for gapi to be ready
                if (!window.gapi || !window.gapi.client) {
                    let attempts = 0;
                    while ((!window.gapi || !window.gapi.client) && attempts < 20) {
                        await new Promise(resolve => setTimeout(resolve, 500));
                        attempts++;
                    }
                    
                    if (!window.gapi || !window.gapi.client) {
                        throw new Error('Google API å°šæœªåˆå§‹åŒ–ï¼Œè«‹ç¨å€™å†è©¦');
                    }
                }
                
                // Set token using gapi
                window.gapi.client.setToken({
                    access_token: tokenData.access_token,
                    expires_in: tokenData.expires_in || 3600,
                    scope: tokenData.scope || SCOPES,
                    token_type: tokenData.token_type || 'Bearer',
                });
                
                // Also try to call window.setGoogleToken if it exists (for main app)
                if (typeof window.setGoogleToken === 'function') {
                    await window.setGoogleToken(tokenData);
                }
                
                statusEl.className = 'status success';
                statusEl.textContent = 'âœ… Token è¨­ç½®æˆåŠŸï¼ç¾åœ¨å¯ä»¥é€²è¡Œé›²ç«¯å‚™ä»½äº†ã€‚';
                
                // Also display the token in the display area
                displayToken(tokenData);
                updateStatus('âœ… Token å·²æ‰‹å‹•è¨­ç½®ä¸¦å¯ç”¨', 'success');
                
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = 'âŒ è¨­ç½®å¤±æ•—: ' + error.message;
            }
        }
        
        // Start initialization
        checkInit();
    </script>
</body>
</html>


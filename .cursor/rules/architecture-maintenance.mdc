---
alwaysApply: true
description: 架構文檔自動維護規則 - 確保 ARCHITECTURE.md 和 docs/features/README.md 與程式碼保持同步
applicableFiles:
  - "*.tsx"
  - "*.ts"
  - "*.js"
  - "*.css"
---

# 架構文檔自動維護規則

當進行以下操作時，**必須**檢查並更新 `ARCHITECTURE.md` 和 `docs/features/README.md`：

**文檔分工**：

- `ARCHITECTURE.md` - 架構層面：服務層、資料模型、技術細節
- `docs/features/README.md` - 功能層面：功能描述、UI 元素、使用者流程

## 觸發更新的情況

### 1. 新增組件或頁面

- ✅ 創建新的 React 組件（`components/*.tsx`）
- ✅ 新增視圖或路由（修改 `App.tsx` 或 `types.ts` 中的 `AppView`）
- ✅ 新增 UI 頁面或功能模組

**更新要求**：

- 在 `docs/features/README.md` 的「功能列表」區段新增功能描述
- 列出 UI 元素、程式碼位置、關鍵功能
- 在 `ARCHITECTURE.md` 的「應用程式流程」區段更新樹狀圖
- **添加 @ARCH 註解標記**（根據 `.arch-annotation-config.json` 配置）

### 2. 新增或修改服務

- ✅ 在 `services/` 目錄下新增檔案
- ✅ 在現有服務中新增公開函數（export function）
- ✅ 修改服務的 API 介面或功能

**更新要求**：

- 在 `ARCHITECTURE.md` 的「服務層架構」區段更新或新增服務描述
- 列出所有公開函數及其功能
- 在 `docs/features/README.md` 中更新相關功能的「程式碼位置」區段

### 3. 修改資料模型

- ✅ 修改 `types.ts` 中的介面或型別
- ✅ 新增或修改資料結構（Flashcard, WordAnalysis 等）
- ✅ 修改資料庫結構（`services/db.ts`）

**更新要求**：

- 在 `ARCHITECTURE.md` 的「資料模型」區段更新型別定義
- 說明變更的欄位及其用途
- 如果影響功能，同時更新 `docs/features/README.md`

### 4. 新增功能或修改現有功能

- ✅ 在現有組件中新增主要功能
- ✅ 修改使用者流程或互動方式
- ✅ 新增或修改 AI 提示詞（影響功能描述）

**更新要求**：

- 在 `docs/features/README.md` 中更新對應功能的「功能描述」和「關鍵功能」
- 更新「常見任務與對應檔案」區段（如適用）
- **添加或更新 @ARCH 註解標記**（UI/FEAT/UX 變更）

### 5. 修改路由或導航

- ✅ 修改 `App.tsx` 中的路由邏輯
- ✅ 新增或修改 `AppView` enum

**更新要求**：

- 在 `ARCHITECTURE.md` 更新「路由與視圖」區段
- 在 `ARCHITECTURE.md` 更新「應用程式流程」樹狀圖
- 在 `docs/features/README.md` 更新「路由與視圖」區段（如適用）

## 標準工作流程

當檢測到上述變更時，**必須**遵循以下標準流程：

### 步驟 1: 開發程式碼

1. **創建或修改檔案**
2. **添加 @ARCH 註解標記**（根據變更類型）
   - 新增組件：`@ARCH:START/END`
   - UI 變更：`@ARCH: Component - UI: 功能名稱`
   - 功能變更：`@ARCH: Component - FEAT: 功能名稱`
   - UX 變更：`@ARCH: Component - UX: 流程名稱`

### 步驟 2: 更新文檔

**必須按照以下順序更新**：

1. **更新 `docs/features/README.md`**（如果涉及功能）

   - 在「功能列表」區段新增或更新功能描述
   - 列出 UI 元素和關鍵功能
   - 更新「常見任務與對應檔案」（如適用）

2. **更新 `ARCHITECTURE.md`**（如果涉及架構）
   - 服務層架構（新增服務時）
   - 資料模型（修改 types.ts 時）
   - 應用程式流程（新增路由時）
   - 路由與視圖（新增路由時）

### 步驟 3: 驗證

**必須執行以下檢查**：

1. **工作流程檢查**

   ```bash
   npm run workflow:check
   ```

   - 檢查是否添加了 @ARCH 註解
   - 檢查文檔是否已更新

2. **文檔同步檢查**

   ```bash
   npm run check-architecture
   ```

   - 檢查文檔是否與程式碼同步

3. **註解驗證**
   ```bash
   npm run arch:validate
   ```
   - 驗證 @ARCH 註解格式正確

### 步驟 4: 提交

只有在所有檢查通過後才能提交：

```bash
git add .
git commit -m "feat: 功能描述"
```

**Pre-commit Hook 會自動執行**：

- `npm run arch:validate` - 註解驗證
- `npm run check-architecture:enhanced` - 文檔同步檢查

## 快速參考

### 變更類型 → 文檔更新對應表

| 變更類型     | @ARCH 註解 | docs/features/README.md | ARCHITECTURE.md |
| ------------ | ---------- | ---------------- | --------------- |
| 新增組件     | ✅ 必須    | ✅ 功能列表      | ✅ 應用程式流程 |
| 新增服務     | ❌ 不需要  | ✅ 程式碼位置    | ✅ 服務層架構   |
| 修改資料模型 | ❌ 不需要  | ❌               | ✅ 資料模型     |
| 新增路由     | ❌ 不需要  | ✅ 路由與視圖    | ✅ 路由與視圖   |
| UI 變更      | ✅ 必須    | ✅ UI 元素       | ❌              |
| 功能變更     | ✅ 必須    | ✅ 關鍵功能      | ❌              |

### 自動化工具

使用以下工具協助工作流程：

```bash
# 分析變更並生成文檔更新建議
npm run doc:update <檔案路徑>

# 檢查工作流程規則
npm run workflow:check

# 檢查文檔同步
npm run check-architecture

# 驗證註解
npm run arch:validate
```

## 強制檢查清單

在提交變更前，**必須**確認以下所有項目：

### 程式碼層面

- [ ] 新增組件已添加 `@ARCH:START/END` 註解
- [ ] UI/UX 變更已添加對應的 `@ARCH` 註解
- [ ] 功能變更已添加 `@ARCH: FEAT` 註解

### 文檔層面

- [ ] 新增的組件已在 `docs/features/README.md` 中記錄（功能列表）
- [ ] 新增的服務已在 `ARCHITECTURE.md` 中記錄（服務層架構）
- [ ] 新增的功能已在 `docs/features/README.md` 中記錄（功能列表）
- [ ] 資料模型變更已反映在 `ARCHITECTURE.md` 中（資料模型）
- [ ] 路由變更已更新兩個文檔（路由與視圖）

### 驗證層面

- [ ] 執行 `npm run workflow:check` 通過
- [ ] 執行 `npm run check-architecture` 通過
- [ ] 執行 `npm run arch:validate` 通過
- [ ] 檔案路徑正確且可訪問
- [ ] 功能描述與實際實作一致

**注意**：Pre-commit Hook 會自動執行部分檢查，但建議在提交前手動執行所有檢查。

## 自動檢查提示

當你進行以下操作時，請主動檢查是否需要更新 `ARCHITECTURE.md`：

```
- 創建新檔案時：檢查是否為組件或服務
- 修改現有檔案時：檢查是否影響功能描述
- 新增 export 函數時：檢查是否為公開 API
- 修改型別定義時：檢查是否影響資料模型
- UI/UX 變更時：添加 @ARCH 註解標記
```

## @ARCH 註解標記要求

根據 `.arch-annotation-config.json` 配置，以下情況**必須**添加註解標記：

### 需要註解的情況

- ✅ **新增組件**：使用 `@ARCH:START/END` 標記整個組件
- ✅ **UI 變更**：使用 `@ARCH: Component - UI: 功能名稱` 標記 UI 元素
- ✅ **功能變更**：使用 `@ARCH: Component - FEAT: 功能名稱` 標記功能邏輯
- ✅ **UX 變更**：使用 `@ARCH: Component - UX: 流程名稱` 標記使用者流程

### 註解格式

```typescript
// @ARCH:START Dashboard - UI: 統計卡片區塊
<div>...</div>
// @ARCH:END Dashboard - UI: 統計卡片區塊

// @ARCH: Dashboard - FEAT: 載入統計
useEffect(() => { ... }, []);
```

### 檢查工具

- `npm run arch:validate` - 檢查變更檔案是否需要註解
- `npm run arch:scan` - 掃描所有註解標記
- `npm run arch:check` - 檢查 hash 同步狀態

詳細說明請參考：`docs/architecture/annotation-example.md`

## 範例

### 範例 1：新增組件

如果創建了 `components/NewFeature.tsx`：

1. 在 `docs/features/README.md` 的「功能列表」區段新增：

```markdown
### 🆕 新功能 (New Feature)

**功能描述**：[功能描述]

**程式碼位置**：

- 組件：`components/NewFeature.tsx`
- [相關服務]

**UI 元素**：

- [列出 UI 元素]

**關鍵功能**：

- [列出關鍵功能]
```

2. 在 `ARCHITECTURE.md` 更新「應用程式流程」樹狀圖
3. 在 `docs/features/README.md` 更新「常見任務與對應檔案」區段（如適用）

### 範例 2：新增服務函數

如果在 `services/geminiService.ts` 中新增 `newFunction()`：

1. 在 `ARCHITECTURE.md` 的「AI 服務」區段的「功能」列表中添加：

```markdown
- `newFunction()` - [功能描述]
```

2. 如果該函數被某個組件使用，在 `docs/features/README.md` 中更新該功能的「程式碼位置」區段

## 注意事項

- **不要**更新文檔的情況：

  - 僅修改純視覺樣式（顏色、字體大小、間距等，不影響功能或 UX）
  - 僅修復 bug 且不影響功能描述
  - 僅重構程式碼結構但功能不變
  - 僅更新註解或文檔字串

- **必須**更新文檔的情況：
  - 新增任何公開 API（export function/component）→ 更新 `ARCHITECTURE.md` 和 `docs/features/README.md`
  - 修改使用者可見的功能 → 更新 `docs/features/README.md`
  - 新增或修改資料結構 → 更新 `ARCHITECTURE.md`
  - 新增路由或視圖 → 更新 `ARCHITECTURE.md` 和 `docs/features/README.md`

### CSS 與樣式變更的處理

**CSS 檔案已包含在 `applicableFiles` 範圍內**，但需要根據變更類型判斷是否需要標記：

- **純視覺調整**（如顏色、字體大小、間距等，不影響功能或 UX）：

  - 不需要更新 `ARCHITECTURE.md`
  - 不需要添加 @ARCH 註解標記

- **影響 UI 結構或 UX 流程的樣式變更**（如響應式佈局、互動狀態、動畫效果、關鍵視覺元素）：
  - 不需要更新 `ARCHITECTURE.md`（CSS 變更不影響架構文檔）
  - **但需要在相關的 TSX 組件檔案中添加 @ARCH 註解標記**（UI/UX 變更）
  - 例如：修改按鈕的 hover 狀態影響互動流程，應在組件中標記 `@ARCH: Component - UX: 按鈕互動狀態`
  - 例如：新增響應式斷點影響佈局，應在組件中標記 `@ARCH: Component - UI: 響應式佈局`

**判斷標準**：

- 如果 CSS 變更影響了使用者的操作流程或互動方式 → 在組件中標記 `UX`
- 如果 CSS 變更影響了 UI 元素的結構或佈局 → 在組件中標記 `UI`
- 如果 CSS 變更僅是視覺美化，不影響功能或互動 → 無需標記

## 維護責任

- **AI Agent**：在進行上述變更時，自動檢查並更新 `ARCHITECTURE.md`
- **開發者**：在 code review 時確認 `ARCHITECTURE.md` 已同步更新

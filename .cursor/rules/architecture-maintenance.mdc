---
alwaysApply: true
description: ARCHITECTURE.md 自動維護規則 - 確保架構文檔與程式碼保持同步
applicableFiles:
  - "*.tsx"
  - "*.ts"
  - "*.js"
  - "*.css"
---

# ARCHITECTURE.md 自動維護規則

當進行以下操作時，**必須**檢查並更新 `ARCHITECTURE.md`：

## 觸發更新的情況

### 1. 新增組件或頁面

- ✅ 創建新的 React 組件（`components/*.tsx`）
- ✅ 新增視圖或路由（修改 `App.tsx` 或 `types.ts` 中的 `AppView`）
- ✅ 新增 UI 頁面或功能模組

**更新要求**：

- 在「功能模組映射」區段新增對應的功能描述
- 列出 UI 元素、程式碼位置、關鍵功能
- 更新「應用程式流程」樹狀圖
- **添加 @ARCH 註解標記**（根據 `.arch-annotation-config.json` 配置）

### 2. 新增或修改服務

- ✅ 在 `services/` 目錄下新增檔案
- ✅ 在現有服務中新增公開函數（export function）
- ✅ 修改服務的 API 介面或功能

**更新要求**：

- 在「服務層架構」區段更新或新增服務描述
- 列出所有公開函數及其功能
- 更新相關功能模組的「程式碼位置」區段

### 3. 修改資料模型

- ✅ 修改 `types.ts` 中的介面或型別
- ✅ 新增或修改資料結構（Flashcard, WordAnalysis 等）
- ✅ 修改資料庫結構（`services/db.ts`）

**更新要求**：

- 在「資料模型」區段更新型別定義
- 說明變更的欄位及其用途

### 4. 新增功能或修改現有功能

- ✅ 在現有組件中新增主要功能
- ✅ 修改使用者流程或互動方式
- ✅ 新增或修改 AI 提示詞（影響功能描述）

**更新要求**：

- 更新對應功能模組的「PRD 描述」和「關鍵功能」
- 更新「常見任務與對應檔案」區段（如適用）
- **添加或更新 @ARCH 註解標記**（UI/FEAT/UX 變更）

### 5. 修改路由或導航

- ✅ 修改 `App.tsx` 中的路由邏輯
- ✅ 新增或修改 `AppView` enum

**更新要求**：

- 更新「路由與視圖」區段
- 更新「應用程式流程」樹狀圖

## 更新流程

當檢測到上述變更時，請遵循以下步驟：

1. **識別變更類型**：判斷屬於哪一類觸發情況
2. **定位相關區段**：在 `ARCHITECTURE.md` 中找到需要更新的區段
3. **更新內容**：
   - 保持現有格式和結構
   - 使用一致的標記符號（📊 ➕ 📚 🎴 等）
   - 確保檔案路徑正確
   - 更新「常見任務與對應檔案」區段（如適用）
4. **驗證完整性**：
   - 檢查所有相關檔案路徑是否正確
   - 確認功能描述與實際程式碼一致
   - 確保沒有遺漏新增的功能點

## 檢查清單

在提交變更前，確認：

- [ ] 新增的組件/服務已在 `ARCHITECTURE.md` 中記錄
- [ ] 檔案路徑正確且可訪問
- [ ] 功能描述與實際實作一致
- [ ] 相關的「常見任務」已更新（如適用）
- [ ] 資料模型變更已反映在文檔中

## 自動檢查提示

當你進行以下操作時，請主動檢查是否需要更新 `ARCHITECTURE.md`：

```
- 創建新檔案時：檢查是否為組件或服務
- 修改現有檔案時：檢查是否影響功能描述
- 新增 export 函數時：檢查是否為公開 API
- 修改型別定義時：檢查是否影響資料模型
- UI/UX 變更時：添加 @ARCH 註解標記
```

## @ARCH 註解標記要求

根據 `.arch-annotation-config.json` 配置，以下情況**必須**添加註解標記：

### 需要註解的情況

- ✅ **新增組件**：使用 `@ARCH:START/END` 標記整個組件
- ✅ **UI 變更**：使用 `@ARCH: Component - UI: 功能名稱` 標記 UI 元素
- ✅ **功能變更**：使用 `@ARCH: Component - FEAT: 功能名稱` 標記功能邏輯
- ✅ **UX 變更**：使用 `@ARCH: Component - UX: 流程名稱` 標記使用者流程

### 註解格式

```typescript
// @ARCH:START Dashboard - UI: 統計卡片區塊
<div>...</div>
// @ARCH:END Dashboard - UI: 統計卡片區塊

// @ARCH: Dashboard - FEAT: 載入統計
useEffect(() => { ... }, []);
```

### 檢查工具

- `npm run arch:validate` - 檢查變更檔案是否需要註解
- `npm run arch:scan` - 掃描所有註解標記
- `npm run arch:check` - 檢查 hash 同步狀態

詳細說明請參考：`docs/ARCHITECTURE_ANNOTATION_EXAMPLE.md`

## 範例

### 範例 1：新增組件

如果創建了 `components/NewFeature.tsx`：

1. 在「功能模組映射」區段新增：

```markdown
### 🆕 新功能 (New Feature)

**PRD 描述**：[功能描述]

**UI 元素**：

- [列出 UI 元素]

**程式碼位置**：

- 組件：`components/NewFeature.tsx`
- [相關服務]

**關鍵功能**：

- [列出關鍵功能]
```

2. 更新「應用程式流程」樹狀圖
3. 更新「常見任務與對應檔案」區段（如適用）

### 範例 2：新增服務函數

如果在 `services/geminiService.ts` 中新增 `newFunction()`：

1. 在「AI 服務」區段的「功能」列表中添加：

```markdown
- `newFunction()` - [功能描述]
```

2. 如果該函數被某個組件使用，更新該組件的「程式碼位置」區段

## 注意事項

- **不要**更新 `ARCHITECTURE.md` 的情況：

  - 僅修改純視覺樣式（顏色、字體大小、間距等，不影響功能或 UX）
  - 僅修復 bug 且不影響功能描述
  - 僅重構程式碼結構但功能不變
  - 僅更新註解或文檔字串

- **必須**更新 `ARCHITECTURE.md` 的情況：
  - 新增任何公開 API（export function/component）
  - 修改使用者可見的功能
  - 新增或修改資料結構
  - 新增路由或視圖

### CSS 與樣式變更的處理

**CSS 檔案已包含在 `applicableFiles` 範圍內**，但需要根據變更類型判斷是否需要標記：

- **純視覺調整**（如顏色、字體大小、間距等，不影響功能或 UX）：

  - 不需要更新 `ARCHITECTURE.md`
  - 不需要添加 @ARCH 註解標記

- **影響 UI 結構或 UX 流程的樣式變更**（如響應式佈局、互動狀態、動畫效果、關鍵視覺元素）：
  - 不需要更新 `ARCHITECTURE.md`（CSS 變更不影響架構文檔）
  - **但需要在相關的 TSX 組件檔案中添加 @ARCH 註解標記**（UI/UX 變更）
  - 例如：修改按鈕的 hover 狀態影響互動流程，應在組件中標記 `@ARCH: Component - UX: 按鈕互動狀態`
  - 例如：新增響應式斷點影響佈局，應在組件中標記 `@ARCH: Component - UI: 響應式佈局`

**判斷標準**：

- 如果 CSS 變更影響了使用者的操作流程或互動方式 → 在組件中標記 `UX`
- 如果 CSS 變更影響了 UI 元素的結構或佈局 → 在組件中標記 `UI`
- 如果 CSS 變更僅是視覺美化，不影響功能或互動 → 無需標記

## 維護責任

- **AI Agent**：在進行上述變更時，自動檢查並更新 `ARCHITECTURE.md`
- **開發者**：在 code review 時確認 `ARCHITECTURE.md` 已同步更新

# 字庫管理與製作新卡片 (Word Library)

## 功能介紹

字庫管理與製作新卡片功能模組提供了完整的單字管理體驗，包括單字庫的瀏覽、搜尋、篩選、排序、查看、編輯和刪除功能，以及新增單字卡片的完整流程。本模組支援多種輸入方式（手動輸入、圖片識別），並整合 AI 分析功能，自動生成適合小三學生的單字分析內容（音節、重音節標記、詞源、例句等）。所有操作都提供即時預覽功能，確保使用者能夠在儲存前確認單字卡的內容。

## UX 路徑

### UX0005: 切換標籤頁（字庫管理 / 製作新卡片）

**觸發條件**：使用者在字庫管理頁面

**操作步驟**：
1. 使用者在字庫管理頁面
2. 點擊「我的字庫」或「製作新卡片」標籤
3. 頁面切換到對應的標籤內容

**預期結果**：
- 標籤頁正確切換
- 對應的內容區域顯示
- 標籤頁狀態正確更新（高亮顯示當前標籤）

---

### UX0006: 搜尋單字

**觸發條件**：使用者在字庫管理標籤頁

**操作步驟**：
1. 使用者在字庫管理標籤頁
2. 在搜尋框輸入單字或定義關鍵字
3. 系統即時過濾單字列表

**預期結果**：
- 搜尋框可以輸入文字
- 輸入後即時過濾單字列表
- 顯示符合搜尋條件的單字（匹配單字或定義）
- 清空搜尋框後恢復顯示所有單字

---

### UX0007: 篩選單字（全部/待複習/已學會）

**觸發條件**：使用者在字庫管理標籤頁

**操作步驟**：
1. 使用者在字庫管理標籤頁
2. 點擊篩選下拉選單
3. 選擇篩選條件（全部/待複習/已學會）
4. 系統過濾單字列表

**預期結果**：
- 下拉選單可以選擇篩選條件
- 選擇後單字列表即時更新
- 顯示符合篩選條件的單字
- 「全部」顯示所有單字
- 「待複習」只顯示待複習的單字
- 「已學會」只顯示已學會的單字

---

### UX0008: 排序單字（A-Z/新增日期/熟練度）

**觸發條件**：使用者在字庫管理標籤頁

**操作步驟**：
1. 使用者在字庫管理標籤頁
2. 點擊排序下拉選單
3. 選擇排序方式（A-Z/新增日期/熟練度）
4. 系統重新排序單字列表

**預期結果**：
- 下拉選單可以選擇排序方式
- 選擇後單字列表即時重新排序
- 「A-Z」按字母順序排序
- 「新增日期」按建立時間排序（最新在前）
- 「熟練度」按熟練度排序（高熟練度在前）

---

### UX0009: 查看單字卡詳情

**觸發條件**：使用者在字庫管理標籤頁，點擊單字卡片

**操作步驟**：
1. 使用者在字庫管理標籤頁
2. 點擊單字列表中的任一單字卡片
3. 系統在右側預覽區域顯示單字卡
4. 可以查看單字的完整資訊

**預期結果**：
- 點擊後右側預覽區域顯示單字卡
- 單字卡顯示完整的資訊（單字、圖片、定義、音節、詞源、例句等）
- 如果單字卡有圖片，正面會顯示圖片
- 單字卡可以翻轉查看背面資訊
- 如果單字卡有圖片生成提示，顯示「重新生成圖片」按鈕

---

### UX0010: 刪除單字卡

**觸發條件**：使用者在字庫管理標籤頁，點擊刪除按鈕

**操作步驟**：
1. 使用者在字庫管理標籤頁
2. 點擊單字卡片上的刪除按鈕
3. 系統顯示確認對話框
4. 確認刪除
5. 系統刪除單字卡並更新列表

**預期結果**：
- 點擊刪除按鈕後顯示確認對話框
- 確認後單字卡從列表中移除
- 如果單字卡詳情彈窗正在顯示該單字，彈窗自動關閉
- 列表即時更新，不再顯示已刪除的單字

---

### UX0011: 手動輸入單字

**觸發條件**：使用者在製作新卡片標籤頁

**操作步驟**：
1. 使用者在製作新卡片標籤頁
2. 在輸入框輸入英文單字或片語
3. 點擊「新增」按鈕或按 Enter 鍵
4. 單字加入待處理列表

**預期結果**：
- 輸入框可以輸入文字
- 點擊「新增」或按 Enter 後，單字加入待處理列表
- 輸入框清空，準備輸入下一個單字
- 如果單字已存在，顯示錯誤訊息
- 待處理列表顯示新加入的單字（狀態為「排隊中」）

---

### UX0012: 圖片上傳與識別

**觸發條件**：使用者在製作新卡片標籤頁

**操作步驟**：
1. 使用者在製作新卡片標籤頁
2. 點擊圖片上傳區域或上傳按鈕
3. 選擇圖片檔案
4. 系統顯示圖片預覽
5. 點擊「識別單字」按鈕
6. 系統分析圖片並提取單字
7. 顯示識別到的單字列表

**預期結果**：
- 可以選擇圖片檔案（支援常見圖片格式）
- 選擇後顯示圖片預覽
- 點擊「識別單字」後開始分析
- 分析過程中顯示載入狀態
- 分析完成後顯示識別到的單字列表
- 可以點擊識別到的單字加入待處理列表
- 可以清除圖片重新上傳

---

### UX0013: AI 分析單字

**觸發條件**：待處理列表中有待分析的單字

**操作步驟**：
1. 待處理列表中有狀態為「排隊中」的單字
2. 系統自動開始分析（按順序處理）
3. 單字狀態變更為「分析中」
4. 系統調用 AI 分析服務
5. 分析完成後狀態變更為「成功」或「失敗」

**預期結果**：
- 系統自動按順序處理待處理列表中的單字
- 分析過程中單字狀態顯示為「分析中」
- 分析成功後生成單字分析資料（音節、重音節、詞源、例句等）
- 分析成功後狀態變更為「成功」，並顯示勾選標記
- 如果分析失敗，狀態變更為「失敗」，顯示錯誤訊息
- 分析失敗的單字可以重試
- 分析完成後自動切換到字庫管理標籤頁並刷新列表

---

### UX0014: 預覽單字卡

**觸發條件**：待處理列表中有分析成功的單字

**操作步驟**：
1. 待處理列表中有狀態為「成功」的單字
2. 點擊該單字項目
3. 系統在預覽區域顯示單字卡

**預期結果**：
- 點擊分析成功的單字後，預覽區域顯示對應的單字卡
- 單字卡顯示完整的分析資訊（單字、定義、音節、詞源、例句等）
- 單字卡可以翻轉查看背面資訊
- 如果沒有選中任何單字，預覽區域顯示提示訊息

---

### UX0015: 儲存新單字卡

**觸發條件**：待處理列表中有分析成功的單字，系統自動儲存

**操作步驟**：
1. 單字分析成功後
2. 系統自動生成圖片（如果 AI 分析包含 imagePrompt）
3. 系統自動將單字卡儲存到資料庫
4. 單字卡狀態變更為「成功」
5. 系統自動切換到字庫管理標籤頁
6. 字庫列表自動刷新

**預期結果**：
- 分析成功後自動儲存單字卡
- 如果圖片生成成功，單字卡包含圖片
- 如果圖片生成失敗，單字卡仍可儲存（僅文字內容）
- 儲存後單字卡出現在字庫列表中
- 系統自動切換到字庫管理標籤頁
- 字庫列表顯示新加入的單字
- 待處理列表中的單字狀態更新為「成功」

---

### UX0032: 重新生成單字卡圖片

**觸發條件**：使用者在字庫管理標籤頁，選擇了有圖片的單字卡

**操作步驟**：
1. 使用者在字庫管理標籤頁
2. 選擇一個有圖片生成提示的單字卡
3. 點擊「重新生成圖片」按鈕
4. 系統開始生成兩張新圖片
5. 顯示模態框，包含原圖和兩張新圖（共三張）
6. 點擊選擇喜歡的圖片
7. 點擊「確認選擇」
8. 系統更新單字卡的圖片

**預期結果**：
- 點擊「重新生成圖片」按鈕後，按鈕顯示「生成中...」狀態
- 生成過程中顯示載入動畫
- 生成完成後打開模態框，顯示三張圖片（原圖 + 兩張新圖）
- 圖片以網格方式排列，每張圖片可點擊選擇
- 選中的圖片有高亮邊框和勾選標記
- 點擊「確認選擇」後更新單字卡圖片
- 如果生成失敗，顯示錯誤訊息
- 可以點擊「取消」關閉模態框，不更新圖片

---

## 程式碼位置

- 主組件：`components/WordLibrary.tsx`
- 單字卡組件：`components/FlashcardComponent.tsx`（統一組件，支援圖片顯示）
- 圖片重新生成模態框：`components/ImageRegenerateModal.tsx`
- AI 服務：`services/geminiService.ts`
  - `analyzeWord()` - 分析單字（適合小三學生）
  - `extractWordsFromImage()` - 從圖片提取單字
  - `generateMnemonicImage()` - 生成單字記憶圖片
- 儲存服務：`services/storageService.ts` (saveCard, createNewCard, checkWordExists, getCards, deleteCard)
- 型別定義：`types.ts` (WordAnalysis, Flashcard)

## UI 元素

- 標籤頁切換（字庫管理 / 製作新卡片）
- 搜尋與篩選功能
- 排序功能（A-Z、新增日期、熟練度）
- 輸入方式選擇：手動輸入、圖片上傳
- 單字列表與編輯
- AI 分析進度顯示
- 單字卡預覽與圖片顯示
- 重新生成圖片按鈕（字庫管理模式下）
- 圖片選擇模態框（三選一）

## 關鍵功能

- 字庫管理
  - 搜尋單字或定義
  - 篩選（全部/待複習/已學會）
  - 排序（A-Z/新增日期/熟練度）
  - 查看、編輯、刪除單字卡
  - 重新生成單字卡圖片（三選一）
- 製作新卡片
  - 單字輸入與驗證
  - 圖片上傳與識別
  - AI 分析（音節、重音節標記、詞源、例句，適合小三學生）
  - 圖片生成（基於 AI 分析的 imagePrompt）
  - 單字卡儲存


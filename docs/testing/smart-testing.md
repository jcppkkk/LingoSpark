# æ™ºæ…§æ¸¬è©¦ç³»çµ±

æœ¬å°ˆæ¡ˆä½¿ç”¨ **lint-staged** + **Vitest related** å¯¦ä½œæ™ºæ…§æ¸¬è©¦ç³»çµ±ï¼Œåœ¨ Git hooks ä¸­è‡ªå‹•åŸ·è¡Œæ¸¬è©¦ï¼Œä½†**åªæ¸¬è©¦æœ‰è®Šå‹•çš„æª”æ¡ˆ**ï¼Œå¤§å¹…æå‡é–‹ç™¼æ•ˆç‡ã€‚

## ç³»çµ±æ¶æ§‹

```
Git Commit
    â†“
Pre-commit Hook (Husky)
    â†“
lint-staged
    â†“
vitest related --run
    â†“
æ‰¾å‡ºè®Šæ›´æª”æ¡ˆçš„ç›¸é—œæ¸¬è©¦
    â†“
åŸ·è¡Œç›¸é—œæ¸¬è©¦
    â†“
å…è¨±/é˜»æ­¢æäº¤
```

## åŠŸèƒ½èªªæ˜

### Vitest `related` å‘½ä»¤

Vitest çš„ `related` å‘½ä»¤æœƒè‡ªå‹•æ‰¾å‡ºèˆ‡è®Šæ›´æª”æ¡ˆç›¸é—œçš„æ¸¬è©¦ï¼š

- âœ… é©ç”¨æ–¼éœæ…‹å¼•å…¥ï¼ˆ`import './index.js'`ï¼‰
- âœ… è‡ªå‹•è¿½è¹¤ import é—œä¿‚
- âœ… åªåŸ·è¡Œç›¸é—œçš„æ¸¬è©¦æª”æ¡ˆ

**æ³¨æ„**ï¼šä¸é©ç”¨æ–¼å‹•æ…‹å¼•å…¥ï¼ˆ`import(filepath)`ï¼‰ã€‚

### lint-staged æ•´åˆ

`lint-staged` æœƒï¼š
1. æ‰¾å‡ºæ‰€æœ‰ staged çš„æª”æ¡ˆ
2. å°æ¯å€‹æª”æ¡ˆåŸ·è¡Œé…ç½®çš„å‘½ä»¤
3. åªè™•ç† staged çš„æª”æ¡ˆï¼Œæé«˜æ•ˆç‡

## é…ç½®

### package.json

```json
{
  "lint-staged": {
    "*.{ts,tsx}": [
      "vitest related --run"
    ]
  }
}
```

**èªªæ˜**ï¼š
- `*.{ts,tsx}` - åŒ¹é…æ‰€æœ‰ TypeScript æª”æ¡ˆ
- `vitest related --run` - åŸ·è¡Œèˆ‡è®Šæ›´æª”æ¡ˆç›¸é—œçš„æ¸¬è©¦
- `--run` - å–®æ¬¡åŸ·è¡Œæ¨¡å¼ï¼ˆlint-staged éœ€è¦ï¼‰

### pre-commit hook

åœ¨ `.husky/pre-commit` ä¸­å·²é…ç½®ï¼š

```bash
# æ™ºæ…§æ¸¬è©¦ï¼šä½¿ç”¨ lint-staged åªæ¸¬è©¦æœ‰è®Šå‹•çš„æª”æ¡ˆ
echo "ğŸ§ª åŸ·è¡Œæ™ºæ…§æ¸¬è©¦ï¼ˆåƒ…æ¸¬è©¦è®Šæ›´çš„æª”æ¡ˆï¼‰..."
npx lint-staged
```

## ä½¿ç”¨æ–¹æ³•

### è‡ªå‹•åŸ·è¡Œï¼ˆPre-commit Hookï¼‰

æ¯æ¬¡ `git commit` æ™‚æœƒè‡ªå‹•åŸ·è¡Œæ™ºæ…§æ¸¬è©¦ï¼š

```bash
git add .
git commit -m "feat: æ–°å¢åŠŸèƒ½"
# è‡ªå‹•åŸ·è¡Œæ™ºæ…§æ¸¬è©¦
```

### æ‰‹å‹•åŸ·è¡Œ

```bash
# åŸ·è¡Œ lint-stagedï¼ˆæ¸¬è©¦æ‰€æœ‰ staged æª”æ¡ˆï¼‰
npx lint-staged

# æˆ–ç›´æ¥ä½¿ç”¨ vitest related
vitest related --run path/to/file.ts
```

## æ¸¬è©¦æª”æ¡ˆåŒ¹é…é‚è¼¯

Vitest `related` æœƒè‡ªå‹•ï¼š

1. **è¿½è¹¤ import é—œä¿‚**ï¼š
   - `components/Dashboard.tsx` â†’ æ‰¾å‡ºæ‰€æœ‰ import å®ƒçš„æ¸¬è©¦æª”æ¡ˆ
   - `services/api.ts` â†’ æ‰¾å‡ºæ‰€æœ‰ä½¿ç”¨å®ƒçš„æ¸¬è©¦æª”æ¡ˆ

2. **éœæ…‹åˆ†æ**ï¼š
   - åˆ†æ `import` å’Œ `require` èªå¥
   - è¿½è¹¤æ¨¡çµ„ä¾è³´é—œä¿‚

3. **åŸ·è¡Œç›¸é—œæ¸¬è©¦**ï¼š
   - åªåŸ·è¡Œèˆ‡è®Šæ›´æª”æ¡ˆç›¸é—œçš„æ¸¬è©¦
   - è‡ªå‹•è·³éä¸ç›¸é—œçš„æ¸¬è©¦

## æ•…éšœæ’é™¤

### å•é¡Œ 1: æ‰¾ä¸åˆ°ç›¸é—œæ¸¬è©¦

**ç—‡ç‹€**ï¼šè®Šæ›´äº†æºæª”æ¡ˆï¼Œä½†æ²’æœ‰åŸ·è¡Œæ¸¬è©¦

**åŸå› **ï¼š
- æ¸¬è©¦æª”æ¡ˆä½¿ç”¨å‹•æ…‹å¼•å…¥ï¼ˆ`import(filepath)`ï¼‰
- æ¸¬è©¦æª”æ¡ˆèˆ‡æºæª”æ¡ˆæ²’æœ‰ import é—œä¿‚

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
1. ç¢ºèªæ¸¬è©¦æª”æ¡ˆæœ‰éœæ…‹å¼•å…¥æºæª”æ¡ˆ
2. ç¢ºèªæ¸¬è©¦æª”æ¡ˆå‘½åç¬¦åˆè¦å‰‡ï¼ˆ`.test.ts` æˆ– `.spec.ts`ï¼‰
3. æ‰‹å‹•åŸ·è¡Œ `vitest related --run path/to/file.ts` æŸ¥çœ‹è¼¸å‡º

### å•é¡Œ 2: æ¸¬è©¦åŸ·è¡Œæ™‚é–“éé•·

**ç—‡ç‹€**ï¼šå³ä½¿åªæ¸¬è©¦è®Šæ›´çš„æª”æ¡ˆï¼ŒåŸ·è¡Œæ™‚é–“ä»ç„¶å¾ˆé•·

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
1. æª¢æŸ¥æ˜¯å¦æœ‰å¤§é‡æ¸¬è©¦æª”æ¡ˆè¢«åŒ¹é…
2. å„ªåŒ–æ¸¬è©¦æª”æ¡ˆï¼Œæ¸›å°‘ä¸å¿…è¦çš„æ¸¬è©¦
3. ä½¿ç”¨ Vitest çš„ä¸¦è¡ŒåŸ·è¡Œï¼ˆé è¨­å·²å•Ÿç”¨ï¼‰

### å•é¡Œ 3: æ¸¬è©¦å¤±æ•—ä½†æƒ³è·³é

**ç—‡ç‹€**ï¼šæ¸¬è©¦å¤±æ•—ï¼Œä½†æƒ³å…ˆæäº¤ä»£ç¢¼

**è§£æ±ºæ–¹æ¡ˆ**ï¼š

```bash
# ä¸å»ºè­°ï¼Œä½†å¯ä»¥ä½¿ç”¨
git commit --no-verify
```

**æ³¨æ„**ï¼šæ‡‰è©²å…ˆä¿®å¾©æ¸¬è©¦éŒ¯èª¤ï¼Œå†æäº¤ä»£ç¢¼ã€‚

## æœ€ä½³å¯¦è¸

1. **ä¿æŒæ¸¬è©¦æª”æ¡ˆå‘½åä¸€è‡´**ï¼š
   - ä½¿ç”¨ `.test.ts` æˆ– `.spec.ts` å¾Œç¶´
   - æ¸¬è©¦æª”æ¡ˆèˆ‡æºæª”æ¡ˆåŒå

2. **ä½¿ç”¨éœæ…‹å¼•å…¥**ï¼š
   - é¿å…ä½¿ç”¨å‹•æ…‹å¼•å…¥ï¼ˆ`import(filepath)`ï¼‰
   - ä½¿ç”¨éœæ…‹å¼•å…¥ï¼ˆ`import './file.ts'`ï¼‰ä»¥ä¾¿ `related` æ­£ç¢ºè¿½è¹¤

3. **æ¸¬è©¦æª”æ¡ˆä½ç½®**ï¼š
   - å„ªå…ˆæ”¾åœ¨ `tests/` ç›®éŒ„ä¸‹
   - æˆ–èˆ‡æºæª”æ¡ˆåŒç›®éŒ„

4. **å®šæœŸåŸ·è¡Œå®Œæ•´æ¸¬è©¦**ï¼š

   ```bash
   npm run test:run  # åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦
   ```

5. **ç›£æ§æ¸¬è©¦è¦†è“‹ç‡**ï¼š

   ```bash
   npm run test:coverage
   ```

## ç›¸é—œå·¥å…·

- **Vitest** - æ¸¬è©¦æ¡†æ¶ï¼Œæä¾› `related` å‘½ä»¤
- **Husky** - Git hooks ç®¡ç†
- **lint-staged** - Staged æª”æ¡ˆè™•ç†å·¥å…·

## åƒè€ƒè³‡æ–™

- [Vitest related æ–‡æª”](https://vitest.dev/guide/cli.html#related)
- [lint-staged æ–‡æª”](https://github.com/lint-staged/lint-staged)
- [Husky æ–‡æª”](https://typicode.github.io/husky/)

# ARCHITECTURE.md 檢測系統分析

## 現有系統的局限性

### ✅ 目前可以檢測的變更

1. **檔案層級**

   - ✅ 新增/刪除組件檔案（`components/*.tsx`）
   - ✅ 新增/刪除服務檔案（`services/*.ts`）

2. **函數層級**
   - ✅ 新增/刪除公開函數（`export function`）
   - ✅ 新增/刪除公開常數（`export const`）

### ❌ 目前無法自動檢測的變更

1. **PRD/UX/UI 層面**

   - ❌ UI 元素的增減（按鈕、表單、輸入框等）
   - ❌ 使用者互動流程的變更
   - ❌ 視覺設計的變更（不影響功能但影響 UX）
   - ❌ PRD 描述的變更（功能目標的改變）

2. **介面層面**

   - ❌ 組件 Props 的變更（新增/刪除/修改 props）
   - ❌ Interface/Type 欄位的變更（部分檢測）
   - ❌ 路由參數的變更

3. **功能流程層面**

   - ❌ 使用者操作流程的變更
   - ❌ 狀態管理的變更
   - ❌ 資料流向的變更

4. **配置層面**
   - ❌ 常數值的變更（僅檢測常數名稱）
   - ❌ 環境變數的變更
   - ❌ 功能開關的變更（部分檢測）

## 改進方案

### 方案 1：增強版檢查工具（已實作）

**檔案**：`scripts/check-architecture-enhanced.js`

**新增檢測能力**：

1. **路由視圖檢測**

   - ✅ 檢查 `AppView` enum 的所有值
   - ✅ 檢查 `App.tsx` 中的路由配置
   - ✅ 驗證所有視圖是否在文檔中記錄

2. **資料模型檢測**

   - ✅ 檢查 `types.ts` 中的所有 Interface/Type
   - ✅ 驗證資料模型是否在文檔中記錄

3. **UI 元素啟發式檢測**

   - ⚠️ 檢測組件中的按鈕、輸入框數量
   - ⚠️ 檢測是否有檔案上傳功能
   - ⚠️ 檢測是否有表單提交
   - ⚠️ 檢測是否有導航功能
   - ⚠️ **注意**：這是啟發式檢查，可能會有誤報

4. **功能開關檢測**
   - ✅ 檢測 `constants.ts` 中的功能開關
   - ✅ 驗證重要常數是否在文檔中記錄

**使用方法**：

```bash
npm run check-architecture:enhanced
```

**優點**：

- 自動化程度更高
- 檢測範圍更廣
- 提供具體的檢查項目

**缺點**：

- UI 元素檢測是啟發式的，可能不準確
- 無法檢測 PRD 描述的變更
- 無法檢測使用者流程的變更

### 方案 2：結構化文檔格式（建議）

**概念**：在 `ARCHITECTURE.md` 中使用結構化格式，便於自動解析

**範例**：

```markdown
### 📊 儀表板 (Dashboard)

**PRD 描述**：顯示學習統計、快速操作入口、雲端同步狀態

**UI 元素**：

- [BUTTON] 開始複習挑戰 - 導航到練習模式
- [BUTTON] 製作新單字卡 - 導航到新增單字
- [BUTTON] 手動同步 - 觸發雲端同步
- [STAT_CARD] 總單字量 - 顯示 stats.totalCards
- [STAT_CARD] 待複習數量 - 顯示 stats.dueCards
- [STAT_CARD] 已學會數量 - 顯示 stats.learnedCount

**Props**：

- `onNavigate: (view: AppView) => void`
- `views: typeof AppView`

**路由**：`AppView.DASHBOARD`
```

**優點**：

- 結構化，便於自動解析
- 可以精確檢測 UI 元素的變更
- 可以檢測 Props 的變更

**缺點**：

- 需要手動維護結構化格式
- 文檔會更長更詳細

### 方案 3：Git Diff 分析（進階）

**概念**：分析 Git diff 來檢測變更類型

**檢測邏輯**：

1. 分析新增的 JSX 元素（`<button>`, `<input>` 等）
2. 分析修改的 Interface 定義
3. 分析新增的路由 case
4. 分析修改的常數值

**優點**：

- 可以精確檢測變更
- 可以追蹤歷史變更

**缺點**：

- 需要 Git 環境
- 實作複雜度較高
- 需要解析 TypeScript/JSX

### 方案 4：AI 輔助檢測（未來方向）

**概念**：使用 AI 分析程式碼變更並建議文檔更新

**流程**：

1. 分析程式碼變更
2. 理解變更的語義（不只是語法）
3. 判斷是否需要更新文檔
4. 生成文檔更新建議

**優點**：

- 可以理解變更的語義
- 可以檢測 PRD/UX 層面的變更
- 可以提供更新建議

**缺點**：

- 需要 AI 模型支援
- 可能會有誤判
- 實作複雜度高

## 建議的混合方案

### 短期（立即實作）

1. **使用增強版檢查工具**

   - 執行 `npm run check-architecture:enhanced`
   - 定期檢查（如每次提交前）

2. **改進文檔結構**

   - 在關鍵組件中列出主要 UI 元素
   - 記錄重要的 Props
   - 記錄路由配置

3. **AI Agent 規則強化**
   - 在 `.cursor/rules/architecture-maintenance.mdc` 中明確列出需要檢查的項目
   - 提供具體的檢查清單

### 中期（逐步改進）

1. **結構化文檔格式**

   - 採用標準化的 UI 元素標記
   - 使用機器可讀的格式

2. **Git Hook 整合**
   - 在 pre-commit 中執行檢查
   - 提供互動式更新提示

### 長期（未來方向）

1. **AI 輔助檢測**

   - 整合 AI 模型分析變更
   - 自動生成文檔更新建議

2. **視覺化工具**
   - 顯示文檔與程式碼的對應關係
   - 視覺化檢測結果

## 檢測準確度評估

### 目前系統（基礎版）

| 檢測項目     | 準確度 | 說明                   |
| ------------ | ------ | ---------------------- |
| 檔案變更     | 100%   | 完全準確               |
| 函數變更     | 90%    | 可能有誤報（內部函數） |
| UI 元素變更  | 0%     | 無法檢測               |
| Props 變更   | 0%     | 無法檢測               |
| 路由變更     | 0%     | 無法檢測               |
| 資料模型變更 | 0%     | 無法檢測               |

### 增強版系統

| 檢測項目     | 準確度 | 說明                               |
| ------------ | ------ | ---------------------------------- |
| 檔案變更     | 100%   | 完全準確                           |
| 函數變更     | 90%    | 可能有誤報                         |
| UI 元素變更  | 60%    | 啟發式檢測，可能有誤報             |
| Props 變更   | 0%     | 無法檢測                           |
| 路由變更     | 95%    | 檢測 AppView enum 和路由配置       |
| 資料模型變更 | 80%    | 檢測 Interface，但無法檢測欄位變更 |

### 理想系統（結構化 + AI）

| 檢測項目     | 準確度 | 說明              |
| ------------ | ------ | ----------------- |
| 檔案變更     | 100%   | 完全準確          |
| 函數變更     | 95%    | 更精確的解析      |
| UI 元素變更  | 90%    | 結構化格式 + 解析 |
| Props 變更   | 90%    | 結構化格式 + 解析 |
| 路由變更     | 100%   | 完全準確          |
| 資料模型變更 | 95%    | 結構化格式 + 解析 |

## 結論

### 現有系統的準確度

**對於 PRD/UX/UI 變更的檢測準確度：約 30-40%**

**原因**：

- ✅ 可以檢測結構性變更（檔案、函數）
- ⚠️ 部分檢測語義變更（路由、資料模型）
- ❌ 無法檢測 UI/UX 層面的變更
- ❌ 無法檢測 PRD 描述的變更

### 建議

1. **立即採用增強版工具**

   - 提高檢測覆蓋率
   - 檢測路由和資料模型變更

2. **強化 AI Agent 規則**

   - 明確列出需要檢查的項目
   - 提供檢查清單

3. **手動審查重要變更**

   - 對於 UI/UX 變更，仍需人工審查
   - 定期檢查文檔完整性

4. **逐步改進**
   - 考慮採用結構化文檔格式
   - 未來整合 AI 輔助檢測

### 最終答案

**現有系統對於 PRD/UX/UI 變更的檢測不夠精確**，但透過增強版工具和改進的規則，可以達到 **60-70% 的檢測準確度**。

要達到更高的準確度（90%+），需要：

1. 結構化文檔格式
2. 更智能的程式碼解析
3. AI 輔助語義分析

但目前系統已經可以：

- ✅ 檢測大部分結構性變更
- ✅ 提醒開發者檢查 UI/UX 變更
- ✅ 提供清晰的檢查報告
